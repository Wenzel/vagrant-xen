---
- name: install useful tools
  package:
    name: "{{ item }}"
  with_items:
    - git
    - build-essential
    - python
    - python-dev
    - python3
    - python3-dev

- name: clone Xen source code
  git:
    repo: 'git://xenbits.xen.org/xen.git'
    dest: /home/vagrant/xen
    version: stable-4.11
  become: false

- name: install xen build dependencies with buid-dep
  apt:
    name: xen
    state: build-dep

- name: configure Xen
  command: ./configure --prefix=/usr --libdir=/usr/lib64 --enable-systemd
  args:
    chdir: /home/vagrant/xen
  become: false

- name: build Xen
  command: make -j2 dist
  args:
    chdir: /home/vagrant/xen
  become: false

- name: install Xen
  command: make install
  args:
    chdir: /home/vagrant/xen

- name: rebuild dynamic linker cache
  command: /sbin/ldconfig

- name: update GRUB to boot on Xen kernel by default
  command: grub-set-default 'Debian GNU/Linux, with Xen hypervisor'

- name: update GRUB2
  command: update-grub2

- name: enable Xen system services
  service:
    name: "{{ item }}"
    enabled: yes
  with_items:
    - xenconsoled.service
    - xendomains.service
    - xenstored.service
