---
- name: install libvirt
  package:
    name: libvirt-daemon-system

- name: add user to libvirt group
  user:
    name: vagrant
    groups: libvirt
    append: yes

- name: set default network as autostart
  command: virsh -c qemu:///system net-autostart default

- name: ensure default libvirt network is started
  command: virsh -c qemu:///system net-start default
  ignore_errors: yes

- name: define libvirt pool
  command: virsh -c qemu:///system pool-define-as default --type dir --target /data/images

- name: build libvirt pool
  command: virsh -c qemu:///system pool-build default

- name: set libvirt pool as autostart
  command: virsh -c qemu:///system pool-autostart default

- name: ensure libvirt pool is started
  command: virsh -c qemu:///system pool-start default
  ignore_errors: yes

- include: download_vm.yml

- name: refresh libvirt pool
  command: virsh -c qemu:///system pool-refresh default

- name: install libvirt-python module to manage VMs
  package:
    name: python-libvirt

- name: define VM in libvirt
  virt:
    name: windows7
    command: define
    xml: "{{ lookup('file', 'domain.xml') }}"
    uri: 'xen:///'
